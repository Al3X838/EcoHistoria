{% extends "base.html" %}

{% block title %}Mi Perfil - UCA Verde{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">
            <span class="icon">üë§</span> Mi Perfil
        </h1>
    </div>

    <div class="profile-grid">
        <!-- Informaci√≥n del Usuario -->
        <div class="card profile-info-card">
            <div class="profile-avatar">
                <div class="avatar-large">{{ current_user.nombre_completo[0] }}</div>
            </div>
            <h2 class="profile-name">{{ current_user.nombre_completo }}</h2>
            <p class="profile-username">@{{ current_user.username }}</p>
            
            <div class="profile-details">
                <div class="detail-item">
                    <span class="detail-icon">üìß</span>
                    <span class="detail-text">{{ current_user.email }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-icon">üèõÔ∏è</span>
                    <span class="detail-text">{{ current_user.facultad }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-icon">üéì</span>
                    <span class="detail-text">{{ current_user.carrera }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-icon">üìÖ</span>
                    <span class="detail-text">Miembro desde {{ current_user.fecha_registro.strftime('%d/%m/%Y') }}</span>
                </div>
            </div>

            <div class="profile-stats-mini">
                <div class="stat-mini">
                    <div class="stat-value">{{ current_user.puntos_totales }}</div>
                    <div class="stat-label">Puntos</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-value">{{ current_user.racha_actual }}</div>
                    <div class="stat-label">Racha</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-value">{{ total_reciclajes }}</div>
                    <div class="stat-label">Reciclajes</div>
                </div>
            </div>

            <div class="profile-level">
                <span class="level-badge-large">{{ current_user.nivel }}</span>
            </div>
        </div>

        <!-- Impacto Ambiental -->
        <div class="card impact-card">
            <h3 class="card-title">üåç Tu Impacto Ambiental Total</h3>
            <div class="impact-grid">
                <div class="impact-item-large">
                    <div class="impact-icon-large">üí®</div>
                    <div class="impact-value-large">{{ impacto.co2_evitado }} kg</div>
                    <div class="impact-label-large">CO‚ÇÇ Evitado</div>
                    <p class="impact-desc">Equivalente a {{ (impacto.co2_evitado / 0.404)|round(1) }} km en auto</p>
                </div>
                <div class="impact-item-large">
                    <div class="impact-icon-large">üíß</div>
                    <div class="impact-value-large">{{ impacto.agua_ahorrada }} L</div>
                    <div class="impact-label-large">Agua Ahorrada</div>
                    <p class="impact-desc">Equivalente a {{ (impacto.agua_ahorrada / 8)|round(0)|int }} duchas</p>
                </div>
                <div class="impact-item-large">
                    <div class="impact-icon-large">üå≥</div>
                    <div class="impact-value-large">{{ impacto.arboles_salvados }}</div>
                    <div class="impact-label-large">√Årboles Salvados</div>
                    <p class="impact-desc">Absorci√≥n de CO‚ÇÇ anual equivalente</p>
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas de Actividad -->
        <div class="card activity-stats-card">
            <h3 class="card-title">üìä Estad√≠sticas de Actividad</h3>
            <div class="activity-stats-list">
                <div class="activity-stat-item">
                    <span class="activity-icon">‚ôªÔ∏è</span>
                    <span class="activity-name">Reciclajes</span>
                    <span class="activity-value">{{ total_reciclajes }}</span>
                </div>
                <div class="activity-stat-item">
                    <span class="activity-icon">üìö</span>
                    <span class="activity-name">Quizzes</span>
                    <span class="activity-value">{{ total_quizzes }}</span>
                </div>
                <div class="activity-stat-item">
                    <span class="activity-icon">üéÅ</span>
                    <span class="activity-name">Canjes</span>
                    <span class="activity-value">{{ total_canjes }}</span>
                </div>
                <div class="activity-stat-item">
                    <span class="activity-icon">üî•</span>
                    <span class="activity-name">Racha Actual</span>
                    <span class="activity-value">{{ current_user.racha_actual }} d√≠as</span>
                </div>
            </div>
        </div>

        <!-- Logros -->
        <div class="card achievements-card">
            <h3 class="card-title">üèÜ Mis Logros ({{ logros_obtenidos|length }}/{{ todos_logros|length }})</h3>
            <div class="achievements-grid-new">
                {% for logro in todos_logros %}
                    {% set unlocked = logro.id in logros_obtenidos %}
                    <a href="{{ url_for('main.logro_detalle', logro_id=logro.id) if unlocked else '#' }}" 
                       class="achievement-badge {{ 'unlocked' if unlocked else 'locked' }}"
                       title="{{ logro.descripcion if unlocked else 'Logro bloqueado' }}">
                        
                        <div class="achievement-badge-icon">
                            {{ logro.icono if unlocked else 'üîí' }}
                        </div>
                        <div class="achievement-badge-info">
                            <h4 class="achievement-badge-name">{{ logro.nombre }}</h4>
                            {% if unlocked %}
                                <span class="achievement-badge-status">Desbloqueado</span>
                            {% else %}
                                <span class="achievement-badge-status">Bloqueado</span>
                            {% endif %}
                        </div>
                    </a>
                {% endfor %}
            </div>
        </div>

        <!-- Historial de Transacciones -->
        <div class="card transactions-card">
            <h3 class="card-title">üìú Historial Completo de Transacciones</h3>
            {% if transacciones %}
                <div class="transactions-list">
                    {% for trans in transacciones[:20] %}
                    <div class="transaction-item">
                        <div class="transaction-icon {{ trans.tipo }}">
                            {% if trans.tipo == 'reciclaje' %}‚ôªÔ∏è
                            {% elif trans.tipo == 'quiz' %}üìö
                            {% elif trans.tipo == 'evento' %}üéâ
                            {% elif trans.tipo == 'canje' %}üéÅ
                            {% elif trans.tipo == 'casino' %}üé∞
                            {% endif %}
                        </div>
                        <div class="transaction-content">
                            <p class="transaction-desc">{{ trans.descripcion }}</p>
                            <p class="transaction-date">{{ trans.fecha.strftime('%d/%m/%Y %H:%M') }}</p>
                        </div>
                        <div class="transaction-points {{ 'positive' if trans.puntos > 0 else 'negative' }}">
                            {{ '+' if trans.puntos > 0 else '' }}{{ trans.puntos }} pts
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if transacciones|length > 20 %}
                    <p class="text-center" style="margin-top: 1rem; color: #6b7280;">
                        Mostrando las √∫ltimas 20 transacciones de {{ transacciones|length }} totales
                    </p>
                {% endif %}
            {% else %}
                <p class="empty-state">No tienes transacciones registradas a√∫n.</p>
            {% endif %}
        </div>
    </div> <!-- Cierre de profile-grid -->

    <!-- üëá SECCI√ìN DE SEGURIDAD (V11 - SIN EMOJIS Y CENTRADO REAL) üëá -->
    <div class="row" style="margin-top: 3rem; margin-bottom: 3rem;">
        <div class="col-md-8 offset-md-2">
            <div class="card" style="background: linear-gradient(145deg, #1f2937, #111827); border: 1px solid #374151; border-radius: 20px; box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.4); overflow: hidden;">
                
                <!-- Barra decorativa -->
                <div style="height: 6px; background: linear-gradient(90deg, #10b981, #047857);"></div>

                <!-- Encabezado -->
                <div class="card-header" style="border: none; background: transparent; padding-top: 2rem; text-align: center;">
                    <h3 style="color: #10b981; font-weight: 800; font-size: 1.6rem; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span>üîí</span> {{ _('Zona de Seguridad') }}
                    </h3>
                    <p style="color: #9ca3af; font-size: 0.9rem; margin: 0;">
                        {{ _('Mant√©n tu cuenta segura cambiando tu contrase√±a peri√≥dicamente.') }}
                    </p>
                </div>

                <div class="card-body" style="padding: 2rem;">
                    <form method="POST" style="max-width: 500px; margin: 0 auto;">
                        {{ form.hidden_tag() }}
                        
                        <!-- Contrase√±a Actual (SIN EMOJIS) -->
                        <div style="margin-bottom: 1.5rem;">
                            <label class="form-label" style="color: #d1fae5; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; display: block;">
                                {{ form.current_password.label }}
                            </label>
                            {% if form.current_password.errors %}
                                {{ form.current_password(class="form-control is-invalid", style="background-color: #111827; border: 1px solid #ef4444; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box;") }}
                                <div style="color: #ef4444; margin-top: 5px; font-size: 0.85rem;">
                                    {{ form.current_password.errors[0] }}
                                </div>
                            {% else %}
                                {{ form.current_password(class="form-control", style="background-color: #111827; border: 1px solid #374151; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box;") }}
                            {% endif %}
                        </div>

                        <!-- Nueva Contrase√±a (SIN EMOJIS) -->
                        <div style="margin-bottom: 1.5rem;">
                            <label class="form-label" style="color: #d1fae5; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; display: block;">
                                {{ form.new_password.label }}
                            </label>
                            {% if form.new_password.errors %}
                                {{ form.new_password(class="form-control is-invalid", style="background-color: #111827; border: 1px solid #ef4444; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box;") }}
                                <div style="color: #ef4444; margin-top: 5px; font-size: 0.85rem;">
                                    {{ form.new_password.errors[0] }}
                                </div>
                            {% else %}
                                {{ form.new_password(class="form-control", style="background-color: #111827; border: 1px solid #374151; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box;") }}
                            {% endif %}
                        </div>

                        <!-- Confirmar Contrase√±a (SIN EMOJIS) -->
                        <div style="margin-bottom: 1.5rem;">
                            <label class="form-label" style="color: #d1fae5; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; display: block;">
                                {{ form.confirm_password.label }}
                            </label>
                            {% if form.confirm_password.errors %}
                                {{ form.confirm_password(class="form-control is-invalid", style="background-color: #111827; border: 1px solid #ef4444; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box;") }}
                                <div style="color: #ef4444; margin-top: 5px; font-size: 0.85rem;">
                                    {{ form.confirm_password.errors[0] }}
                                </div>
                            {% else %}
                                {{ form.confirm_password(class="form-control", style="background-color: #111827; border: 1px solid #374151; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box;") }}
                            {% endif %}
                        </div>

                        <!-- Bot√≥n Centrado y Separado -->
                        <div style="text-align: center; margin-top: 2.5rem;">
                            {{ form.submit(class="btn", style="background: linear-gradient(90deg, #10b981, #059669); border: none; border-radius: 50px; padding: 12px 40px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); transition: transform 0.2s; display: inline-block; cursor: pointer;") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div> <!-- Cierre de container -->
{% endblock %}